---
import Layout from '../../components/Layout.astro'

interface Tag {
  title: string
  slug: string
  description: string
  posts: Array<{
    title: string
    slug: string
    description: string
  }>
}

export async function getStaticPaths() {
  const { data } = await fetch(
    process.env.WEBINY_READ_URL,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.WEBINY_ACCESS_TOKEN}`,
        'Content-Type' : 'application/json'
      },
      body: JSON.stringify({
        query: `
          {
            listPosts {
              data {
                id
                title
                slug
                description
                tags {
                  title
                  slug
                }
              }
            }
          }
        `,
      }),
    }
  ).then (
    response => response.json()
  )

  const tagsArrayFromPostsList = data.listPosts.data.reduce((prev, { tags, ...post }) => {
    tags.forEach(tag => {
      prev.set(tag.slug, {
        title: tag.title,
        slug: tag.slug,
        posts: [...(prev.get(tag.slug)?.posts || []), post],
      })
    });
    return prev;
  }, new Map());

const content:Tag[] = Array.from(tagsArrayFromPostsList.values())

  return content.map((tag) => {
    return {
      params: { slug: tag.slug },
      props: { tag },
    };
  });
}
const { tag } = Astro.props;
---
<Layout pageTitle="home" pageDescription={tag.description}>
  <main class="container max-w-screen-sm py-20">
    <h1 class="text-2xl">Articles about {tag.title}:</h1>
    <ul class="list-disc list-inside">
      {tag.posts.map(post => (
        <li><a class="hover-underline py-2 px-1 inline-block" href={`/post/${post.slug}`}>{post.title}</a></li>
      ))}
    </ul>
  </main>
</Layout>
